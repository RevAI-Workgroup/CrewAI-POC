# [3-10] Chat Streaming Endpoint

## Description
Implement HTTP streaming endpoint for chat messages that integrates with CrewAI execution. This endpoint will receive chat messages, create dynamic CrewAI tasks, execute the crew, and stream responses back to the client in real-time.

## Status History
| Timestamp | Event | From_Status | To_Status | Details | User |
|-----------|-------|-------------|-----------|---------|------|
| 2024-12-27 | user_approves | Proposed | Agreed | Task created and approved for implementation | User |
| 2024-12-27 | start_work | Agreed | InProgress | Started implementation of chat streaming endpoint | AI_Agent |
| 2024-12-27 | submit_for_review | InProgress | Review | Completed chat streaming endpoint implementation | AI_Agent |

## Requirements

### Core Functionality
- **HTTP Streaming Endpoint**: `/api/messages/chat/stream` POST endpoint
- **Real-time Response**: Stream CrewAI execution output as chunks
- **CrewAI Integration**: Translate graph data to executable crews
- **Dynamic Task Creation**: Create CrewAI tasks from chat messages
- **Execution Management**: Create and manage execution records
- **Error Handling**: Comprehensive error management with streaming support

### Technical Requirements
- **Request Schema**: Use existing `ChatMessageRequest` from task 3-9
- **Response Format**: HTTP text/event-stream with JSON chunks
- **Authentication**: JWT token validation
- **Access Control**: Validate thread and graph ownership
- **Execution Protection**: Prevent concurrent crew runs per graph
- **Transaction Management**: Handle database operations during streaming

### Integration Points
- **ThreadService**: For thread validation and access control
- **GraphTranslationService**: Convert graph data to CrewAI objects
- **MessageProcessingService**: Create user and assistant messages
- **Execution Model**: Track crew execution with real-time updates

## Implementation Plan

### 1. Endpoint Structure
```python
@router.post("/chat/stream")
async def send_chat_message_stream(
    request: ChatMessageRequest,
    current_user: User = Depends(get_current_user),
    db: Session = Depends(get_db)
) -> StreamingResponse
```

### 2. Validation Flow
- Validate thread access via ThreadService
- Check graph ownership and single crew restriction  
- Prevent concurrent execution for same graph
- Validate graph data for CrewAI translation

### 3. Message Creation
- Create user message record
- Create placeholder assistant message
- Link assistant message to execution record

### 4. CrewAI Execution
- Translate graph to CrewAI objects via GraphTranslationService
- Create dynamic task from message content and optional output
- Execute crew and stream response chunks
- Update execution and message records during streaming

### 5. Streaming Protocol
- Content-Type: `text/event-stream`
- Chunk format: `data: {"content": "chunk", "message_id": "id"}\n\n`
- Completion: `data: {"done": true, "message_id": "id"}\n\n`
- Error: `data: {"error": "message", "done": true}\n\n`

## Test Plan

### Unit Tests
- Request validation with invalid data
- Thread access control validation
- Graph ownership verification
- Execution protection logic
- CrewAI integration error handling

### Integration Tests
- End-to-end streaming flow
- Database transaction handling during streaming
- Message and execution record creation
- Error scenarios with proper cleanup

### Performance Tests
- Streaming response latency
- Memory usage during long executions
- Concurrent request handling
- Database connection management

## Verification

### Success Criteria
- [ ] Endpoint accepts ChatMessageRequest and validates all fields
- [ ] Thread and graph access control works correctly
- [ ] Execution protection prevents concurrent runs
- [ ] CrewAI translation and execution works with streaming
- [ ] Messages and execution records are created and updated properly
- [ ] Error handling provides clear feedback to clients
- [ ] Streaming response format follows specification
- [ ] Database transactions are handled correctly during streaming

### Error Scenarios
- [ ] Invalid thread ID returns 404
- [ ] Unauthorized access returns 403  
- [ ] Concurrent execution returns 409
- [ ] Graph translation errors are handled gracefully
- [ ] CrewAI execution failures are caught and reported
- [ ] Database errors during streaming are handled properly

## Files Modified

### Backend Files
- `backend/routers/messages.py` - Add chat streaming endpoint
- `backend/schemas/message_schemas.py` - Ensure ChatMessageRequest exists (from task 3-9)
- `backend/services/graph_translation.py` - May need updates for dynamic task creation
- Tests: `tests/routers/test_messages.py` - Add streaming endpoint tests

### Dependencies
- Requires completed tasks: 3-4 (ThreadService), 3-7 (Execution Protection), 3-9 (Chat Schemas)
- Integrates with: GraphTranslationService, MessageProcessingService
- Prepares for: Task 3-11 (Dynamic Task Creation), 3-12 (Execution Record Management)

---

**Links:**
- **Parent PBI**: [PBI-003: Chat Interface with CrewAI Integration](../../prd.md)
- **Task Index**: [PBI-003 Tasks](../tasks.md)
- **Previous Task**: [3-9: Chat Message Schemas](PBI-003-9.md)
- **Next Task**: [3-11: Dynamic Task Creation](PBI-003-11.md) 